# План действий — ArchPlanks

## 1. Краткий анализ проекта

**Что это:** плагин Archicad (AC29) для работы с пиломатериалами и планом распила. Репозиторий: [DGersmv/ArchPlanks](https://github.com/DGersmv/ArchPlanks).

**Текущее состояние:**
- **Собрано и работает:** лицензии/демо, главное меню, тулбар (Close / Таблица / Поддержка), палитра «Таблица выделенного» (Selection Details), палитра «Поддержка» (Help).
- **Частично готово:** палитра «Отправка в Excel» — есть только HTML/JS (`Send_Xls_Palette.html`), вызывается `ACAPI.OpenSendXlsPalette()` и `ACAPI.SaveSendXls()`, но в C++ **нет** класса палитры, регистрации и реализации сохранения CSV.
- **Не реализовано:** функционал «План распила» (Cutting Plan) — алгоритм раскладки, хелпер Archicad, палитра, GDL-объект CutPlanBoard в библиотеке.
- **Несогласованность имён:** в документации и путях встречаются `Browser_Repl_Int`, `LandscapeHelper_AC29`, `ArchPlanks`; выходной .apx в Release — `LandscapeHelper_AC29.apx`. Лицензия проверяет `LandscapeHelper_AC29` или `Browser_Repl_Int`, но не `ArchPlanks`.

---

## 2. Приоритеты и план по этапам

### Этап 0 — Привести в порядок проект (низкий риск)

| # | Задача | Детали |
|---|--------|--------|
| 0.1 | **Обновить BUILD_INSTRUCTIONS.md** | Заменить путь `Browser_Repl_Int` на `ArchPlanks`; указать корректный путь к папке проекта (текущий: `...\Examples\ArchPlanks`). |
| 0.2 | **Унифицировать имя плагина** | Решить: оставить выходной файл `LandscapeHelper_AC29.apx` (и имена в лицензии) или перейти на `ArchPlanks_AC29.apx`. Если переименовывать — обновить CMakeLists.txt, LicenseManager (ожидаемые PLUGIN_NAME), LICENSE_SYSTEM.md, license.example.lic. |
| 0.3 | **Удалить мусорные файлы в корне** | Файлы вида `-files  Select-String...`, `bject -First 5` — похожи на случайно сохранённый вывод PowerShell; удалить. |
| 0.4 | **Проверить сборку** | После правок: `cmake -S . -B build`, `cmake --build build --config Release`; убедиться, что .apx появляется в `ToArchicad/Release/`. |

---

### Этап 1 — Довести «Отправка в Excel» (Send Xls)

По плану [Send_xls_plan.md](Send_xls_plan.md) UI и логика в HTML готовы, но C++ и регистрация отсутствуют.

| # | Задача | Детали |
|---|--------|--------|
| 1.1 | **Класс палитры SendXlsPalette** | По образцу `SelectionDetailsPalette`: свой класс, GUID, ресурс палитры (DLG + Browser), загрузка `Send_Xls_Palette.html`. |
| 1.2 | **Регистрация в ресурсах** | В `ResourceIDs.hpp` — ID палитры и HTML. В `Browser_ReplFix.grc` (или RINT) — `'DATA'` для HTML палитры Send Xls. В `Browser_Repl.grc` — при необходимости отдельная кнопка или оставить вызов из Selection_Test. |
| 1.3 | **Регистрация в Main/BrowserRepl** | В `Initialize()` / регистрации палитр — создание и показ SendXlsPalette. В `RegisterACAPIJavaScriptObject()` зарегистрировать: `OpenSendXlsPalette`, `SaveSendXls(data)` (принимает строку CSV, открывает диалог сохранения, пишет файл). |
| 1.4 | **Реализация SaveSendXls в C++** | Использовать `ACAPI_Interface(APIIo_Save)` или аналог для выбора пути; запись переданной строки в файл (UTF-8, разделитель по соглашению с JS). |
| 1.5 | **Уведомление после экспорта** | По плану п.5: после успешного сохранения — уведомление пользователю и при необходимости лог в основной палитре. |
| 1.6 | **Локализация и тесты** | Обновить переводы для кнопки «Отправить в Excel» и строк палитры; проверить экспорт CSV и кодировку. |

---

### Этап 2 — Реализовать «План распила» (Cutting Plan)

По плану [CuttingPlan_plan.md](CuttingPlan_plan.md): источник данных — объекты **ArchiFramePlank**, результат — объекты **CutPlanBoard** на выбранном этаже.

| # | Задача | Детали |
|---|--------|--------|
| 2.1 | **CuttingStockSolver (ядро)** | Модуль без ACAPI: структуры `Part`, `SolverParams`, `ResultBoard`, `SolverResult`; функция `Solve()`. Алгоритм: подготовка деталей, Best-Fit Decreasing, размещение с учётом slit/trimLoss, локальное улучшение (Swap/Move/Repack) с лимитом по времени/итерациям. |
| 2.2 | **CutPlanBoardHelper (ACAPI)** | Определить, является ли элемент ArchiFramePlank (libInd + file_UName); извлечение AddPars (iHeight, iLen, iMaxLen, iWidth). Сбор деталей из выделения → вызов Solver → создание элементов CutPlanBoard на этаже (boardL, boardW, cut1..cut20, kerfWidth и т.д.). |
| 2.3 | **Библиотечная часть CutPlanBoard** | GDL уже описан в `GDLScripts/` (PARAMETERS, Master/2D/3D). Добавить/подключить объект CutPlanBoard.gsm в библиотеку плагина или проекта. |
| 2.4 | **Палитра «План распила»** | HTML-палитра: параметры slit, trimLoss, A, B, strictA_B; выбор этажа; таблица деталей из ArchiFramePlank; кнопка «Создать план распила». Регистрация в ResourceIDs, .grc, кнопка в меню/тулбаре. |
| 2.5 | **Интеграция в меню** | Обработчик кнопки/пункта меню → открытие палитры CutPlan; при «Создать» — вызов CutPlanBoardHelper с параметрами из палитры. |
| 2.6 | **Тестирование** | Выделение ArchiFramePlank → запуск плана распила → проверка создания CutPlanBoard на этаже и корректности раскладки. |

---

### Этап 3 — Документация и релиз

| # | Задача | Детали |
|---|--------|--------|
| 3.1 | **BUILD_INSTRUCTIONS.md** | Актуальные пути, опционально раздел «Экспорт в Excel» и «План распила». |
| 3.2 | **LICENSE_SYSTEM.md** | При смене имени плагина — обновить PLUGIN_NAME и пути; при необходимости добавить ArchPlanks_AC29 в список допустимых имён. |
| 3.3 | **Краткий README** | Описание плагина, требования (Archicad 29, Windows), сборка, установка, лицензия, ссылка на репозиторий. |

---

## 3. Зависимости между этапами

- **Этап 0** можно делать в любой момент; желательно до этапов 1–2, чтобы сборка и имена были предсказуемыми.
- **Этап 1** не зависит от этапа 2; «Отправка в Excel» можно довести отдельно.
- **Этап 2** опирается на существующие хелперы: RandomizerHelper (AddPars), SelectionHelper (выделение), LandscapeHelper (создание элементов, этаж). GDL для CutPlanBoard уже есть в репозитории.
- **Этап 3** — после стабилизации функционала и имён.

---

## 4. Риски и примечания

- **Лицензия:** при переименовании плагина в `ArchPlanks_AC29` нужно обновить проверку в `LicenseManager.cpp` (ожидаемые имена) и все лицензионные файлы/документацию.
- **ArchiFramePlank:** в проекте есть GDL для **плана распила** (CutPlanBoard). Библиотечная часть **ArchiFramePlank.gsm** должна быть в библиотеке Archicad/проекта; плагин только проверяет имя по `file_UName` и читает параметры.
- **Мусорные файлы:** перед удалением убедиться, что это не нужные скрипты (по именам похожи на артефакты командной строки).

---

## 5. Чек-лист «с чего начать»

- [ ] Выполнить этап 0 (пути, имена, мусор, сборка).
- [ ] Решить: сначала Send Xls (этап 1) или План распила (этап 2).
- [ ] Для Send Xls: создать `SendXlsPalette.cpp/hpp`, зарегистрировать палитру и `OpenSendXlsPalette`/`SaveSendXls` в JS API.
- [ ] Для План распила: реализовать `CuttingStockSolver`, затем `CutPlanBoardHelper`, затем UI и кнопку.

Если нужно, можно детализировать любой из пунктов (например, сигнатуры функций Solver или формат вызова `SaveSendXls`).
